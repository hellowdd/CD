<%@ page contentType="text/html" pageEncoding="UTF-8" %>
<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title></title>
		<link rel="stylesheet" href="${pageContext.request.contextPath}/css/bootstrap.min.css" />
		<link rel="stylesheet" href="${pageContext.request.contextPath}/css/sub.css" />
		<style type="text/css">
			.txt-red{
				color: red;
			}
		</style>
		<script type="text/javascript" src="${pageContext.request.contextPath}/js/jquery-1.9.1.min.js" ></script>
		<script type="text/javascript" src="${pageContext.request.contextPath}/js/bootstrap.min.js" ></script>
		<script type="text/javascript" src="${pageContext.request.contextPath}/js/laypage-v1.3/laypage/laypage.js" ></script>
		<script type="text/javascript" src="${pageContext.request.contextPath}/js/base.js" ></script>
		<!--[if lt IE 9]>
			<style type="text/css">
				.layui-layer{
					border: 1px solid #ccc;
				}
			</style>
     	<script src="${pageContext.request.contextPath}/js/html5shiv.min.js"></script>
     	<script src="${pageContext.request.contextPath}/js/respond.min.js"></script>
		<![endif]-->
	</head>
	<body>
		<div style="margin:20px;">
			<div class="toolbar" style="border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 0;">
				<button class="btn btn-default" id="addDirectory"><span class="glyphicon glyphicon-plus"></span> 新建目录</button>
				<button class="btn btn-default" id="eidtDirectory"><span class="glyphicon glyphicon-pencil"></span> 修改目录</button>
				<button class="btn btn-default" id="delDirectory"><span class="glyphicon glyphicon-minus"></span> 删除</button>
				<button class="btn btn-default" id="moveDirectory"><span class="glyphicon glyphicon-share-alt"></span> 移动</button>
			</div>
			<div id="route" class="route">
				<a href="javascript:void(0)" directoryId="0">根目录</a>
			</div>
			<div id="folderList" class="folder-container"></div>
			<div id="directoryTree" style="display:none;">
				<div id="tree"></div>
			</div>
		</div>
	</body>
	<script type="text/javascript">
		//存储数据
		var store;
		var storeWidget;
		//面包屑
		var seledRoute = [""];
		var seledRouteTxt = ["根目录"];
		$(document).on("ready",function(){
			//获取数据
      query({
    	  "directoryId":""
      });
      
			//通过面包屑切换目录
      $("#route").on("click","a",function(e){
    	  var a = $(e.currentTarget);
    	  var last;
    	  //先过滤出面包屑的列表
    	  for(var i=0;i<seledRoute.length;i++){
    		  if(seledRoute[i] == a.attr("directoryId")){
    			  last = i+1;
    			  break;
    		  }
    	  }
    	  seledRoute.splice(last,seledRoute.length-1);
    	  seledRouteTxt.splice(last,seledRouteTxt.length-1);
    	  /* console.log(seledRoute); */
    	  var routeStrList = [];
				for(var i=0;i<seledRoute.length;i++){
					routeStrList.push('<a href="javascript:void(0)" directoryId="'+seledRoute[i]+'">'+seledRouteTxt[i]+'</a>');
				}
				$("#route").html(routeStrList.join(">"));
				var obj = a.attr("directoryId") != ""?{
					directoryId:a.attr("directoryId"),
					directoryName:a.html()
				}:{
					"directoryId":""
				};
				query(obj);
			});
			
      //选择控件或目录
			$("#folderList").on("click","a",function(e){
				var a = $(e.currentTarget);
				if(!a.hasClass("seled")){
					$("#folderList").find(".seled").removeClass("seled");
					a.addClass("seled");
				}
			});
			
			//双击进入目录
			$("#folderList").on("dblclick",".folder",function(e){
				var a = $(e.currentTarget);
				seledRoute.push(a.attr("directoryId"));
				seledRouteTxt.push(a.html());
				var routeStrList = [];
				for(var i=0;i<seledRoute.length;i++){
					routeStrList.push('<a href="javascript:void(0)" directoryId="'+seledRoute[i]+'">'+seledRouteTxt[i]+'</a>');
				}
				$("#route").html(routeStrList.join(">"));
				var obj = {
					directoryId:a.attr("directoryId"),
					directoryName:a.html()
				}
				query(obj);
			});
			
			//新建目录
			$("#addDirectory").on("click",function(){
				window.parent.layer.prompt({title: '请输入文件夹名称', formType: 0}, function(text, index){
					if(text.replace(/[\u4e00-\u9fa5]/g,"aa").length>40){
						window.parent.layer.alert("文件夹名称字数超过限制,最多20个字");
						return;
					}
					var parentDirectoryId = seledRoute[seledRoute.length-1];
					var parentDirectoryName = seledRouteTxt[seledRouteTxt.length-1];
			    $.ajax({
		        dataType: "json",
		        //type: "POST",
		        data:{
		        	directoryName:text,
		        	parentDirectoryId:parentDirectoryId
		        },
		        url: "${pageContext.request.contextPath}/manager/widgetDirectory/creatDirectoryInfo",
		        cache: false,
		        success: function(res) {
		          if(res.success){
		        	  window.parent.layer.close(index);
		        	  var obj = {
									directoryId:parentDirectoryId
								}
								if(parentDirectoryId != ""){
									obj.directoryName = parentDirectoryName
								}
		        	  query(obj);
		          }else{
		          	window.parent.layer.alert(res.message);
		          }
		        },
		        error: function() {
		          window.parent.layer.alert("创建目录失败！");
		        }
		      });
			  });
			});
			
			//编辑目录
			$("#eidtDirectory").on("click",function(){
				var folderList = $("#folderList").find(".seled");
				if(folderList.length>0){
					if(!folderList.eq(0).attr("directoryId")){
						window.parent.layer.alert("只能修改目录，控件升级请到控件列表操作！");
						return;
					}
					window.parent.layer.prompt({title: '请输入文件夹名称', formType: 0}, function(text, index){
						if(text.replace(/[\u4e00-\u9fa5]/g,"aa").length>40){
							window.parent.layer.alert("文件夹名称字数超过限制,最多20个字");
							return;
						}
						var parentDirectoryId = seledRoute[seledRoute.length-1];
						var parentDirectoryName = seledRouteTxt[seledRouteTxt.length-1];
						directoryId = folderList.eq(0).attr("directoryId");
						$.ajax({
			        dataType: "json",
			        //type: "POST",
			        data:{
			        	directoryName:text,
			        	parentDirectoryId:parentDirectoryId,
			        	directoryId:directoryId
			        },
			        url: "${pageContext.request.contextPath}/manager/widgetDirectory/updateDirectoryInfo",
			        cache: false,
			        success: function(res) {
			          if(res.success){
			        	  window.parent.layer.close(index);
			        	  var obj = {
										directoryId:parentDirectoryId
									}
									if(parentDirectoryId != ""){
										obj.directoryName = parentDirectoryName
									}
			        	  query(obj);
			          }else{
			          	window.parent.layer.alert(res.message);
			          }
			        },
			        error: function() {
			          window.parent.layer.alert("修改目录失败！");
			        }
			      });
					});
				}else{
					window.parent.layer.alert("请先选择一个目录！");
				}
			});
			
			//删除目录
			$("#delDirectory").on("click",function(){
				$("#delDirectory").blur();
				var list = $("#folderList").find(".seled");
				if(list.length>0){
					if(list.eq(0).attr("directoryId")){
						var parentDirectoryId = seledRoute[seledRoute.length-1];
						var parentDirectoryName = seledRouteTxt[seledRouteTxt.length-1];
						directoryId = list.eq(0).attr("directoryId");
						$.ajax({
			        dataType: "json",
			        //type: "POST",
			        data:{
			        	directoryId:directoryId
			        },
			        url: "${pageContext.request.contextPath}/manager/widgetDirectory/removeDirectoryInfo",
			        cache: false,
			        success: function(res) {
			          if(res.success){
			        	  var obj = {
										directoryId:parentDirectoryId
									}
									if(parentDirectoryId != ""){
										obj.directoryName = parentDirectoryName
									}
			        	  query(obj);
			          }else{
			          	window.parent.layer.alert("删除目录失败！"+res.message);
			          }
			        },
			        error: function() {
			          window.parent.layer.alert("删除目录失败！");
			        }
			      });
					}else{
						var parentDirectoryId = seledRoute[seledRoute.length-1];
						var parentDirectoryName = seledRouteTxt[seledRouteTxt.length-1];
						$.ajax({
			        dataType: "json",
			        //type: "POST",
			        url: "${pageContext.request.contextPath}/manager/widget/deleteWidget",
			        data:{
			        	widgetId:list.eq(0).attr("widgetId"),
			        	widgetPath:parentDirectoryId
			        },
			        cache: false,
			        success: function(res) {
			          if(res.success){
			          	var obj = {
										directoryId:parentDirectoryId
									}
									if(parentDirectoryId != ""){
										obj.directoryName = parentDirectoryName
									}
									query(obj);
			          }else{
			          	window.parent.layer.alert("删除控件失败！"+res.message);
			          }
			        },
			        error: function() {
			          window.parent.layer.alert("删除控件失败！");
			        }
			      });
					}
				}else{
					window.parent.layer.alert("请先选择一个目录！");
				}
			});
			
			//移动目录，控件移动和目录移动调用不同方法
			$("#moveDirectory").on("click",function(){
				$("#moveDirectory").blur();
				var folderList = $("#folderList").find(".seled");
				if(folderList.length>0){
					window.parent.layer.open({
						  type: 2,
						  title: '移动至',
						  shade: 0.3,
						  area: ['600px', '410px'],
						  content: '${pageContext.request.contextPath}/manager/view/directoryTree', //iframe的url
						  success:function(layero, index){
						    window.parent.winList.push(index);
						  }
						}); 
				}else{
					window.parent.layer.alert("请先选择一个目录！");
				}
			});
		});
		
		//获取目录
		function query(obj) {
			//获取目录
			$.ajax({
        dataType: "json",
        //type: "POST",
        data:obj,
        url: "${pageContext.request.contextPath}/manager/widgetDirectory/getDirectoryInfo",
        cache: false,
        success: function(res) {
          if(res.success){
          	store = res;
          	createAll();
          }else{
          	window.parent.layer.alert(res.message);
          }
        },
				error: function(jqXHR,textStatus,errorThrown) {
					if(jqXHR.readyState == 0 && jqXHR.responseText == "" && XHR.status == 0 && jqXHR.statusText == "error"){
						
					}else{
						window.parent.layer.alert("获取目录失败！");
					}
        }
      });
			
			//获取控件
			
			if(obj.directoryId != ""){
				$.ajax({
	        dataType: "json",
	        //type: "POST",
	        data:{
		       	pageNum:1,
		       	pageSize:10000,
		       	directoryId:obj.directoryId
		      },
	        url: "${pageContext.request.contextPath}/manager/widget/getWidgetList",
	        cache: false,
	        success: function(res) {
	          if(res.success){
	        	  storeWidget = res;
	        	  createAll();
	          }else{
	          	window.parent.layer.alert(res.message);
	          }
	        },
					error: function(jqXHR,textStatus,errorThrown) {
						if(jqXHR.readyState == 0 && jqXHR.responseText == "" && XHR.status == 0 && jqXHR.statusText == "error"){
							
						}else{
							window.parent.layer.alert("获取目录失败！");
						}
					}
	      });
			}else{
				storeWidget = {data:[]};
				createAll();
			}
		}
		
		//只有当2次ajax都获得结果了才会添加内容
		function createAll(){
			if(store && storeWidget){
				$("#folderList").empty();
				var strDirectory = getFolderStr();
				var strWidget = getWidgetStr();
				if(strDirectory != "" || strWidget != ""){
					$("#folderList").html(strDirectory+strWidget);
				}else{
					$("#folderList").html('<p style="text-align:center; color: #999;">没有内容</p>');
				}
				store = null;
				storeWidget = null;
			}
		}
		
		function getFolderStr(){
			var str = "";
			if(store.data.length>0){
				for(var i=0;i<store.data.length;i++){
					str += '<a href="javascript:void(0)" class="folder" directoryId="'+store.data[i].id+'" title="'+store.data[i].directorName+'">'+store.data[i].directorName+'</a>';
				}
			}
			return str;
		}
		
		function getWidgetStr(){
			var str = "";
			if(storeWidget.data.length>0){
				for(var i=0;i<storeWidget.data.length;i++){
					str += '<a href="javascript:void(0)" class="widget" widgetId="'+storeWidget.data[i].id+'" widget_name_show="'+storeWidget.data[i].widget_name_show+'" title="'+storeWidget.data[i].widget_name+'" typeId = "'+storeWidget.data[i].widget_type_id+'">'+storeWidget.data[i].widget_name+'</a>';
				}
			}
			return str;
		}
	</script>
</html>
