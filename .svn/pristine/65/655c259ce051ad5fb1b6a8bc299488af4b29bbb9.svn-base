<%@ page contentType="text/html" pageEncoding="UTF-8" %>
<%
	String type = request.getParameter("type")==null?"":request.getParameter("type");
	String ip = request.getParameter("ip")==null?"":request.getParameter("ip");
%>
<!DOCTYPE html>
<html>

  <head>
    <meta charset="UTF-8">
    <title></title>
		<link rel="stylesheet" href="${pageContext.request.contextPath}/css/bootstrap.min.css" />
		<link rel="stylesheet" href="${pageContext.request.contextPath}/css/bootstrap-select.min.css" />
		<link rel="stylesheet" href="${pageContext.request.contextPath}/js/zTree_v3-master/css/zTreeStyle/zTreeStyle.css" type="text/css">
		<style type="text/css">
			.main{
				padding:20px;
			}
			.txt-red{
				color: red;
			}
		</style>
		<script type="text/javascript" src="${pageContext.request.contextPath}/js/jquery-1.9.1.min.js"></script>
		<script type="text/javascript" src="${pageContext.request.contextPath}/js/bootstrap.min.js"></script>
		<script type="text/javascript" src="${pageContext.request.contextPath}/js/bootstrap-select.min.js"></script>
		<script type="text/javascript" src="${pageContext.request.contextPath}/js/jquery-form.js" ></script>
		<script type="text/javascript" src="${pageContext.request.contextPath}/js/zTree_v3-master/js/jquery.ztree.core.js"></script>
		<script type="text/javascript" src="${pageContext.request.contextPath}/js/layer/layer.js"></script>
		<script type="text/javascript" src="${pageContext.request.contextPath}/js/ajaxfileupload.js"></script>
		<script type="text/javascript" src="${pageContext.request.contextPath}/js/form.js"></script>
		<!--[if lt IE 9]>
			<style type="text/css">
				.layui-layer{
					border: 1px solid #ccc;
				}
			</style>
	      	<script src="${pageContext.request.contextPath}/js/html5shiv.min.js"></script>
	      	<script src="${pageContext.request.contextPath}/js/respond.min.js"></script>
		<![endif]-->
  </head>

  <body>
	<form id="widgetForm" class="main">
	 <%-- <div class="form-group">
	    <label for="widgetName">控件名称 <b class="txt-red">*</b></label>
	    <input type="text" class="form-control" id="widgetName" name="widgetName" placeholder="控件名称" placeholder="必填，最多255个字符，一个汉字算2个字符" requried=true len="255" tip="必填，最多255个字符，一个汉字算2个字符" />
	  </div>
		<div class="form-group">
	    <label for="widgetVersion">控件类别 <b class="txt-red">*</b></label>
	    <select id="widgetType" class="selectpicker" data-width="100%"></select>
	  </div>
	  <div class="form-group">
	    <label for="widgetVersion">端类型 <b class="txt-red">*</b></label>
	    <select id="appType" class="selectpicker" data-width="100%">
	    	<option value="0">桌面端</option>
	    	<option value="1">大屏端</option>
	    	<option value="2">移动端</option>
	    </select>
	  </div>
	  <div class="form-group">
	    <label for="widgetVersion">控件版本 <b class="txt-red">*</b></label>
	    <input type="text" class="form-control" id="widgetVersion" name="widgetVersion" placeholder="控件版本" placeholder="必填，最多32位，只能包含数字和." requried=true len="32" reg="version" tip="必填，最多32位，只能包含数字和." />
	  </div>--%>
	  <div class="form-group">
	    <label for="widgetVersion">选择目录 (根目录不可选)<b class="txt-red">*</b></label>
	    <ul id="tree" class="ztree" style="height:120px; border:1px solid #ccc; background-color:#fafafa; overflow:auto;"></ul>
	  </div>
	 <%-- <div class="form-group">
	    <label for="widgetVersion">说明</label>
	    <textarea class="form-control" id="content" name="content" name="content" placeholder="说明" len="1024" tip="最多1024个字符，一个汉字算2个字符."></textarea>
	  </div>--%>
	  <div class="form-group">
	    <label for="exampleInputFile">控件压缩包<b class="txt-red">*</b></label>
	    <input type="file" id="inputfile" name="inputfile">
	  </div>
	  <button type="button" id="upload" class="btn btn-default" style="float: right;">上传</button>
	</form>
	<iframe style="display:none" id="callback" src=""></iframe>
  </body>
  <script type="text/javascript" id="mainJs">
  	var setting = {
			callback:{
				beforeExpand: function(treeId, treeNode) {
					query({
						directoryId:treeNode.id,
						directoryName:treeNode.name
					},treeNode);
			    return true;
				},
				beforeClick: function(treeId, treeNode, clickFlag) {
				    return (treeNode.id !== "");
				}
			}
		};
		
		var treeObj;
		
  	$(document).on("ready",function(){
  		var type = "<%=type%>";
  		var ip = "<%=ip%>";
			
			//获取控件类别
			$.ajax({
	      dataType: "json",
	      //type: "POST",
	      url: "${pageContext.request.contextPath}/manager/widgetType/getWidgetType",
	      cache: false,
	      success: function(res) {
	        if(res.success){
						var innerStr = "";
						for(var i=0;i<res.data.length;i++){
							innerStr += '<option value="'+res.data[i].id+'">'+res.data[i].widgetTypeName+'</option>';
						}
						$("#widgetType").html(innerStr);
						$("#widgetType").selectpicker('refresh');
	        }else{
	        	window.parent.layer.alert(res.message);
	        }
	      },
	      error: function() {
	        window.parent.layer.alert("获取目录失败！");
	      }
	    });
  		
  		autoCheckForm("widgetForm");
  		
  		//创建树
  		//初始根节点不需要查询
			var zNodes =[{
				id:"",
   			name:"根目录",
   			isParent:true
			}];
			treeObj = $.fn.zTree.init($("#tree"), setting, zNodes);
			
  		$("#upload").on("click",function(){
  			checkForm("widgetForm");
				if(!canSubmit){
					return;
				}
				if(!$("#inputfile").val()){
					window.parent.layer.alert("请选择要上传的控件！");
					return;
				}else{
					var extensionName = $("#inputfile").val().split(".").pop();
					if(extensionName != "zip"){
						window.parent.layer.alert("要上传的控件必须zip格式压缩！");
						return;
					}
				}
  			var widgetName = $("#widgetName").val();
  			var version = $("#widgetVersion").val();
  			var date = new Date();
  			var formData = new FormData(); 
  			var node = treeObj.getSelectedNodes()[0];
				if(!node){
					window.parent.layer.alert("请选择目录！");
					return;
				}
  			formData.append('content', "");
  			formData.append('inputfile', $('#inputfile')[0].files[0]);
  			formData.append('widgetName',"");
  			formData.append('directoryId',node.id);
  			$.ajax({ 
	  			type: "POST", 
	  			url: "${pageContext.request.contextPath}/manager/widget/uploadWidget",
	  			data: formData, 
	  			processData : false, 
	  			contentType : false , 
	  			/* xhr: function(){ 
		  			var xhr = $.ajaxSettings.xhr(); 
		  			if(onprogress && xhr.upload) { 
			  			xhr.upload.addEventListener("progress" , onprogress, false); 
			  			return xhr; 
		  			} 
	  			},  */
	  			success:function (res) {
	  			    console.log(res)
		  			if(res.success){
                        window.parent.layer.alert("上传成功",function(i){
                            window.parent.layer.close(i);
                            window.parent.frames["mainFrame"].query(window.parent.frames["mainFrame"].pageNum);
                            window.parent.layer.close(window.parent.winList.pop());
                        });
                        /*if(type&&ip){
                            $("#callback").attr("src",ip+"/pac-web/widgetFrame/callBack.jsp?widgetName="+encodeURI(encodeURI(widgetName))+"&widgetVersion="+version+"&widgetId="+res.data+"&type="+type+"_="+date.getTime());
                        }else{

                        }*/
		  			}else{
		  				try{
		  					window.parent.layer.alert(res.message);
		  				}catch(e){
		  					layer.alert("上传失败");
		  				}
		  			}
	  			}, 
	  			error: function (data, status, e) {
	  				try{
	  					window.parent.layer.alert("上传失败");
	  				}catch(e){
	  					layer.alert("上传失败");
	  				}
	  			} 
  			});

  		});
  	});
  	
  	function query(params,node){
			var paramsObj = params?params:{};
			if(paramsObj.directoryId == 0){
				paramsObj = {};
			}
			$.ajax({
	      dataType: "json",
	      //type: "POST",
	      data:paramsObj,
	      url: "${pageContext.request.contextPath}/manager/widgetDirectory/getDirectoryInfo",
	      cache: false,
	      success: function(res) {
	        if(res.success){
	        	var store = res.data;
	        	var childNodes = [];
	        	//var toMoveDirectory = window.parent.frames["mainFrame"].$("#folderList").find(".seled").eq(0);
	        	for(var i=0;i<store.length;i++){
	        		//if(toMoveDirectory.attr("directoryId") != store[i].id){
		        		childNodes.push({
		        			id:store[i].id,
		        			name:store[i].directorName,
		        			isParent:true
		        		});
	        		//}
	        	}
						treeObj.removeChildNodes(node);
	        	treeObj.addNodes(node, childNodes);
	        }else{
	        	window.parent.layer.alert(res.message);
	        }
	      },
	      error: function() {
	        window.parent.layer.alert("获取目录失败！");
	      }
	    });
		}
  </script>
</html>